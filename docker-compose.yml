version: "3.8"

services:
    # Neo4j Graph Database
    neo4j:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: idor-neo4j
        ports:
            - "7474:7474" # HTTP Browser
            - "7687:7687" # Bolt protocol
        environment:
            - NEO4J_AUTH=neo4j/testpassword
            - NEO4J_dbms_memory_pagecache_size=512M
            - NEO4J_dbms_memory_heap_initial__size=512M
            - NEO4J_dbms_memory_heap_max__size=1G
        volumes:
            - neo4j_data:/data
            - neo4j_logs:/logs
        healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider localhost:7474 || exit 1"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        networks:
            - idor-network

    # Flask Application
    app:
        build:
            context: .
            dockerfile: Dockerfile.app
        container_name: idor-app
        ports:
            - "5000:5000" # Flask server
        environment:
            - NEO4J_URI=bolt://neo4j:7687
            - NEO4J_USER=neo4j
            - NEO4J_PASSWORD=testpassword
            - GEMINI_API_KEY=${GEMINI_API_KEY}
            - SERVER_HOST=0.0.0.0
            - SERVER_PORT=5000
            - DEBUG=${DEBUG:-false}
            - LOG_LEVEL=${LOG_LEVEL:-INFO}
            - BATCH_SIZE=${BATCH_SIZE:-5}
        volumes:
            - ./src:/app/src # Mount source code for development
            - ./main.py:/app/main.py
        depends_on:
            neo4j:
                condition: service_healthy
        networks:
            - idor-network
        restart: unless-stopped

volumes:
    neo4j_data:
        driver: local
    neo4j_logs:
        driver: local

networks:
    idor-network:
        driver: bridge
